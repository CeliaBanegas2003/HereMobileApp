# .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: write

jobs:
  build-backend:
    name: Build & Push Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('hereapp-backend/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build with Maven
        working-directory: hereapp-backend
        run: mvn clean package -DskipTests

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: hereapp-backend
          file: hereapp-backend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/heremobileapp-backend:latest
            ${{ secrets.DOCKER_USERNAME }}/heremobileapp-backend:${{ github.sha }}

  build-mobile-app:
    name: Build Mobile APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Set up Java for Android
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-pub-cache-${{ hashFiles('hereapp-frontend/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-cache-

      - name: Install dependencies
        working-directory: hereapp-frontend
        run: |
          echo "Installing Flutter dependencies..."
          flutter pub get

      # - name: Analyze Flutter code
      #   working-directory: hereapp-frontend
      #   run: |
      #     echo "Running Flutter analysis..."
      #     flutter analyze --no-fatal-infos || echo "Analysis completed with warnings/infos"

      # - name: Run Flutter tests
      #   working-directory: hereapp-frontend
      #   run: |
      #     echo "Running Flutter tests..."
      #     if [ -d "test" ] && [ "$(ls -A test)" ]; then
      #       flutter test || echo "Some tests failed, but continuing build..."
      #     else
      #       echo "No tests found, skipping test execution"
      #     fi

      - name: Build APK
        working-directory: hereapp-frontend
        run: |
          echo "Building Android APK..."
          # Build APK sin firma para CI/CD
          flutter build apk --release --no-shrink
          echo "APK built successfully!"
          ls -la build/app/outputs/flutter-apk/

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: heremobileapp-${{ github.sha }}
          path: hereapp-frontend/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: Create Release (only on main branch)
        if: github.ref == 'refs/heads/main'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            üöÄ Nueva versi√≥n de HereMobileApp
            
            **Cambios incluidos:**
            - Backend actualizado (SHA: ${{ github.sha }})
            - APK m√≥vil actualizado
            
            **Descargas:**
            - APK para Android disponible como artefacto
            - Imagen Docker del backend: `${{ secrets.DOCKER_USERNAME }}/heremobileapp-backend:${{ github.sha }}`
          draft: false
          prerelease: false

  deploy-backend:
    name: Deploy Backend
    needs: [build-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Backend
        run: |
          echo "üöÄ Desplegando backend..."
          echo "Imagen Docker: ${{ secrets.DOCKER_USERNAME }}/heremobileapp-backend:${{ github.sha }}"
          echo "Aqu√≠ puedes a√±adir tu l√≥gica de despliegue espec√≠fica"
          # Por ejemplo:
          # - Desplegar a AWS ECS
          # - Actualizar Kubernetes
          # - Usar docker-compose en servidor
          # - Etc.

  notify-success:
    name: Notify Success
    needs: [build-backend, build-mobile-app, deploy-backend]
    runs-on: ubuntu-latest
    if: success() && github.ref == 'refs/heads/main'
    steps:
      - name: Success Notification
        run: |
          echo "‚úÖ ¬°Despliegue completado exitosamente!"
          echo "üì± APK disponible en: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "üê≥ Backend desplegado con imagen: ${{ secrets.DOCKER_USERNAME }}/heremobileapp-backend:${{ github.sha }}"